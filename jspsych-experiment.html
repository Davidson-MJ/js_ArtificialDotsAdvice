<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerosity Experiment</title>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background-color: #808080;
        }

        .jspsych-html-button-response-stimulus {
            color: white !important;
        }

        .pis-text p {
            color: white !important;
        }

        .stimulus-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 200px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
        }

        .dot-frame {
            width: 300px;
            height: 300px;
            border: 2px solid white;
            position: relative;
        }

        .dot {
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .fixation {
            color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .response-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .sliders-wrapper {
            display: flex;
            gap: 100px;
            align-items: center;
        }

        .custom-slider {
            width: 200px;
            height: 20px;
            background: white;
            position: relative;
            cursor: pointer;
        }

        .marker {
            width: 5px;
            height: 20px;
            background: black;
            position: absolute;
            top: 0;
            display: none;
        }

        .marker.active {
            display: block;
        }

        .confidence-value {
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="jspsych-experiment"></div>

    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>

    <script>
        const jsPsych = initJsPsych({
            display_element: 'jspsych-experiment',
            on_finish: function () {
                jsPsych.data.displayData();
            }
        });


        function generateDots(num) {
            let dots = '';
            for (let i = 0; i < num; i++) {
                let x = Math.random() * 290;
                let y = Math.random() * 290;
                dots += `<div class="dot" style="width: 8px; height: 8px; left: ${x}px; top: ${y}px;"></div>`;
            }
            return dots;
        }

        const messages = {

            PIS: {
                type: jsPsychHtmlButtonResponse,
                stimulus: `
                    <div class="jspych-content" style="color: white;">
                    <div style="
                    font-size: 24px; 
                    font-weight: bold;
                    text-align: center;
                    line-height: 2.2;"
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh; 
                    flex-direction: column;">
                    <br><br>Participant Information Sheet <br><br>[placeholder].<br>
                    </div>
                    </div>`,
                choices: ["I consent"],
                button_html: '<button style="font-size: 20px; padding: 15px 30px; position: absolute; top: 90%; left: 50%; transform: translate(-50%, -50%);">%choice%</button>',
            },

            instructions: {
                timeline: [
                    {
                        type: jsPsychHtmlButtonResponse,
                        stimulus: function () {
                            const slideNumber = jsPsych.timelineVariable('slideNum');
                            return `
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    background-color: #808080;">
                                    <img 
                                        src="instruction-images/Presentation1/Slide${slideNumber}.jpeg" 
                                        alt="Experiment Instructions" 
                                        style="
                                            width: 100%;
                                            height: 100%;
                                            object-fit: contain;
                                        "
                                    >
                                </div>`;
                        },
                        choices: ["Continue"],
                        button_html: '<button style="font-size: 20px; padding: 15px 30px; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">%choice%</button>',
                    }
                ],
                timeline_variables: [
                    { slideNum: 1 },
                    { slideNum: 2 },
                    { slideNum: 3 },
                    { slideNum: 4 },
                    { slideNum: 5 }
                ]
            },


            coverstory: {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<div class="jspych-content" style="color: white;">
                    <div style="
                    font-size: 24px; 
                    font-weight: bold;
                    text-align: centre;
                    line-height: 2.2;"
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh; 
                    flex-direction: column;
                    colour: white;
                    ">   
                    <p>In this experiment, you will have the opportunity to receive advice... [cover story placeholder]</p>
                    <p>Press the button below to begin.</p>
                </div> </div> `,
                choices: ['Start']
            },

        }

        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation" style="font-size:48px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 1000,
        };



        function generateDots(num) {
            let dots = '';
            for (let i = 0; i < num; i++) {
                let x = Math.random() * 290;
                let y = Math.random() * 290;
                dots += `<div class="dot" style="width: 8px; height: 8px; left: ${x}px; top: ${y}px;"></div>`;
            }
            return dots;
        }

        const numerosityTrial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: () => generateStimulus(),
            choices: "NO_KEYS",
            trial_duration: 600,
            data: {
                task: 'numerosity'
            }
        };


        // Randomly select advice condition for each trial
        function getAdviceCondition() {
            return jsPsych.randomization.sampleWithoutReplacement([1, 2, 3], 1)[0];
        }
        // Get random advice direction
        function getAdviceDirection() {
            return jsPsych.randomization.sampleWithoutReplacement(['left', 'right'], 1)[0];
        }
        // Create advice choice trial
        const adviceChoice = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">Would you like to receive advice?</div>',
            choices: ['Yes', 'No'],
            data: {
                task: 'advice_choice'
            },
            on_finish: function (data) {
                // Store the choice for use in conditional timeline
                jsPsych.data.addProperties({
                    advice_requested: data.response === 0 ? true : false
                });
            }
        };

        // Create advice display trials
        const adviceDisplay = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">You will now receive advice</div>',
            choices: ['Continue'],
            data: {
                task: 'advice_display'
            }
        };
        const actualAdvice = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                const direction = getAdviceDirection();
                return `<div style="color: white; font-size: 24px;">${direction}</div>`;
            },
            choices: "NO_KEYS",
            trial_duration: 800,
            data: {
                task: 'actual_advice'
            },
            on_finish: function (data) {
                // Store the advice given
                data.advice_direction = data.stimulus.includes('left') ? 'left' : 'right';
            }
        };
        const noAdviceDisplay = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">No advice available</div>',
            choices: ['Continue'],
            data: {
                task: 'no_advice_display'
            }
        };

        const blankScreen = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '',
            choices: "NO_KEYS",
            trial_duration: 300,
            data: {
                task: 'blank_screen'
            }
        };
        // Add this QUEST class after your initial const declarations and before the timeline setup

        class QuestStaircase {
            constructor(initialDifference = 150, tGuess = 100, tGuessSd = 50, pThreshold = 0.75, beta = 3.5, delta = 0.01, gamma = 0.5) {
                this.tGuess = tGuess;  // Initial guess of threshold
                this.tGuessSd = tGuessSd;  // Standard deviation of initial guess
                this.pThreshold = pThreshold;  // Target threshold probability
                this.beta = beta;  // Steepness of psychometric function
                this.delta = delta;  // Lapse rate
                this.gamma = gamma;  // Guess rate

                // Initialize pdf array for possible threshold values
                this.tValues = Array.from({ length: 1000 }, (_, i) => i);
                this.pdf = this.tValues.map(t =>
                    Math.exp(-0.5 * Math.pow((t - this.tGuess) / this.tGuessSd, 2))
                );
                this.normalizePdf();

                this.trials = [];
                this.initialDifference = initialDifference;
                this.currentDifference = initialDifference;
            }

            getNextDifference() {
                if (this.trials.length < 3) {
                    return this.initialDifference;  // Use initial difference for first few trials
                }

                const mean = this.tValues.reduce((sum, t, i) => sum + t * this.pdf[i], 0);
                this.currentDifference = Math.round(mean);
                return this.currentDifference;
            }

            update(difference, correct) {
                this.trials.push({ difference, correct });

                const likelihood = this.tValues.map(t =>
                    this.psychometricFunction(t, difference, correct)
                );

                this.pdf = this.pdf.map((p, i) => p * likelihood[i]);
                this.normalizePdf();
            }

            psychometricFunction(threshold, intensity, correct) {
                const p = this.gamma + (1 - this.gamma - this.delta) *
                    (1 - Math.exp(-Math.pow(intensity / threshold, this.beta)));
                return correct ? p : (1 - p);
            }

            normalizePdf() {
                const sum = this.pdf.reduce((a, b) => a + b, 0);
                this.pdf = this.pdf.map(p => p / sum);
            }

            getThresholdEstimate() {
                const mean = this.tValues.reduce((sum, t, i) => sum + t * this.pdf[i], 0);
                return Math.round(mean);
            }
        }

        // Initialize QUEST
        const quest = new QuestStaircase();

        // Modify your generateStimulus function to use QUEST
        function generateStimulus() {
            let difference = quest.getNextDifference();
            let baseNumber = 300;  // Base number
            let smallerNumber = baseNumber - difference;  // Subtract difference for comparison

            // Randomly assign numbers to sides (50/50 chance)
            let leftDots, rightDots;
            if (Math.random() < 0.5) {
                leftDots = baseNumber;
                rightDots = smallerNumber;
            } else {
                leftDots = smallerNumber;
                rightDots = baseNumber;
            }
            // Store the current dots for later reference
            jsPsych.data.write({
                leftDots: leftDots,
                rightDots: rightDots,
                difference: difference
            });

            return `
            <div class="stimulus-container">
                <div class="dot-frame">
                    ${generateDots(leftDots)}
                </div>
                <div class="dot-frame">
                    ${generateDots(rightDots)}
                </div>
            </div>`;
        }


        const confidenceResponse = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return `
            <div class="response-container" style="flex-direction: column; gap: 40px;">
                <div class="sliders-wrapper">
                    <div class="slider-container">
                        <span>Left</span>
                        <div id="left-slider" class="custom-slider">
                            <div id="left-marker" class="marker"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; width: 200px; margin-top: 5px;">
                            <span style="font-size: 12px;">Sure Left</span>
                            <span style="font-size: 12px;">Guess Left</span>
                        </div>
                        <!-- Hidden value container -->
                        <div id="left-value" class="confidence-value" style="display: none;">50%</div>
                    </div>
                    
                    <div class="slider-container">
                        <span>Right</span>
                        <div id="right-slider" class="custom-slider">
                            <div id="right-marker" class="marker"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; width: 200px; margin-top: 5px;">
                            <span style="font-size: 12px;">Guess Right</span>
                            <span style="font-size: 12px;">Sure Right</span>
                        </div>
                        <!-- Hidden value container -->
                        <div id="right-value" class="confidence-value" style="display: none;">50%</div>
                    </div>
                </div>
                <button id="continue-button" style="padding: 10px 30px; cursor: not-allowed; opacity: 0.6; margin-top: 20px;" disabled>Continue</button>
            </div>`;
            },
            choices: "NO_KEYS",
            on_load: function () {
                let selectedValue = null;
                let selectedSide = null;

                function updateSlider(e, slider, marker, valueDisplay, side, otherMarker, otherValueDisplay) {
                    const rect = slider.getBoundingClientRect();
                    let pos = (e.clientX - rect.left) / rect.width;
                    pos = Math.max(0, Math.min(1, pos));

                    // Calculate confidence value
                    let confidenceValue;
                    if (side === 'left') {
                        // For left slider: 100% at left edge (pos=0), 50% at right edge (pos=1)
                        confidenceValue = 100 - (pos * 50);
                    } else {
                        // For right slider: 50% at left edge (pos=0), 100% at right edge (pos=1)
                        confidenceValue = pos * 50 + 50;
                    }

                    // Reset other slider
                    otherMarker.classList.remove('active');
                    otherValueDisplay.textContent = '50%';

                    // Update current slider
                    marker.style.left = (pos * 100) + '%';
                    marker.classList.add('active');
                    selectedValue = confidenceValue;
                    valueDisplay.textContent = selectedValue.toFixed(1) + '%'; // Update hidden value
                    selectedSide = side;

                    // Enable continue button and update its style
                    const continueButton = document.getElementById('continue-button');
                    continueButton.disabled = false;
                    continueButton.style.opacity = '1';
                    continueButton.style.cursor = 'pointer';
                }
                // event listeners:
                const leftSlider = document.getElementById('left-slider');
                const rightSlider = document.getElementById('right-slider');
                const leftMarker = document.getElementById('left-marker');
                const rightMarker = document.getElementById('right-marker');
                const leftValue = document.getElementById('left-value');
                const rightValue = document.getElementById('right-value');

                leftSlider.addEventListener('click', function (e) {
                    updateSlider(e, leftSlider, leftMarker, leftValue, 'left', rightMarker, rightValue);
                });

                rightSlider.addEventListener('click', function (e) {
                    updateSlider(e, rightSlider, rightMarker, rightValue, 'right', leftMarker, leftValue);
                });

                document.getElementById('continue-button').addEventListener('click', function () {
                    const data = {
                        selected_side: selectedSide,
                        confidence_value: selectedValue,
                        left_confidence: selectedSide === 'left' ? selectedValue : 50,
                        right_confidence: selectedSide === 'right' ? selectedValue : 50
                    };

                    //Quest Update logic
                    const lastTrial = jsPsych.data.get().filter({ task: 'numerosity' }).last(1).values()[0];
                    if (lastTrial) {
                        const leftDots = lastTrial.leftDots;
                        const rightDots = lastTrial.rightDots;
                        const difference = lastTrial.difference;

                        const correct = (selectedSide === 'left' && leftDots > rightDots) ||
                            (selectedSide === 'right' && rightDots > leftDots);

                        quest.update(difference, correct);

                        console.log(`Confidence was ${selectedValue.toFixed(1)}% ${selectedSide}`);
                        console.log(`Response was ${correct ? 'correct' : 'incorrect'}`);
                        console.log(`Current threshold estimate: ${quest.getThresholdEstimate()}`);

                        data.correct = correct;
                        data.threshold = quest.getThresholdEstimate();
                    }
                    
                    jsPsych.finishTrial({ ...data, correct: correct, threshold: quest.getThresholdEstimate() });
                });
            },
            data: {
                task: 'confidence'
            }
        };


        // Create the timeline
        const timeline = [];
        timeline.push(messages.PIS);
        timeline.push(messages.instructions);
        //timeline.push(messages.coverstory);
        // create practice trial procedure:
        const practiceProcedure = {
            timeline: [
                fixation,
                numerosityTrial,
                {...confidenceResponse,
                data: {task:'confidence_first'}
                },                
            ]
        }
        //insert practice trials.
        for (let ipractice = 0; ipractice < 10; ipractice++) {
            timeline.push(practiceProcedure);
        }

        // Create trial procedure
        for (let i = 0; i < 5; i++) {
            const trialProcedure = {
                timeline: [
                    fixation,
                    numerosityTrial,
                    {...confidenceResponse,
                        data:{task: 'confidence_first'}
                    },               

                    // Condition 1: choice for advice
                    {timeline: [adviceChoice,
                        //show advice if yes: 
                            {timeline: [adviceDisplay, actualAdvice],
                                conditional_function: function () {
                                    const data = jsPsych.data.get().last(1).values()[0];
                                    return data.response === 0; // Only if they chose 'Yes'
                                }
                            },
                        // no advice if no:    
                            {timeline: [noAdviceDisplay, blankScreen],
                                conditional_function: function () {
                                    const data = jsPsych.data.get().last(1).values()[0];
                                    return data.response === 1; // Only if they chose 'No'
                                }
                            }
                        ],
                        conditional_function: function () {                            
                            return jsPsych.timelineVariable('condition') === 1;
                        }
                    },
                    // Condition 2: Always show advice
                    {timeline: [adviceDisplay, actualAdvice],
                        conditional_function: function () {
                            
                            return jsPsych.timelineVariable('condition') === 2;
                        }
                    },
                    // Condition 3: No advice available
                    {timeline: [noAdviceDisplay, blankScreen],
                        conditional_function: function () {
                            
                            return jsPsych.timelineVariable('condition') === 3;
                        }
                    },
                    {...confidenceResponse,data:{task: 'confidence_first'} },// Second confidence rating
                ],

                // randomly select condition 1, 2, or 3.
                timeline_variables: [{
                    condition: getAdviceCondition()
                }]
            };

            timeline.push(trialProcedure);
        }

        jsPsych.run(timeline);



    </script>
</body>

</html>