<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerosity Experiment</title>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background-color: #808080;
        }
        .stimulus-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 200px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
        }
        .dot-frame {
            width: 300px;
            height: 300px;
            border: 2px solid white;
            position: relative;
        }
        .dot {
            background: white;
            border-radius: 50%;
            position: absolute;
        }
        .fixation {
            color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .response-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            color: white;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .sliders-wrapper {
            display: flex;
            gap: 100px;
            align-items: center;
        }
        .custom-slider {
            width: 200px;
            height: 20px;
            background: white;
            position: relative;
            cursor: pointer;
        }
        .marker {
            width: 5px;
            height: 20px;
            background: black;
            position: absolute;
            top: 0;
            display: none;
        }
        .marker.active {
            display: block;
        }
        .confidence-value {
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="jspsych-experiment"></div>
    
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>

    <script>
        const jsPsych = initJsPsych({
            display_element: 'jspsych-experiment',
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });

        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation" style="font-size:48px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 1000,
        };

        function generateStimulus() {
            let leftDots = jsPsych.randomization.sampleWithoutReplacement([150, 175], 1)[0];
            let rightDots = leftDots === 150 ? 175 : 150;
            return `
                <div class="stimulus-container">
                    <div class="dot-frame">
                        ${generateDots(leftDots)}
                    </div>
                    <div class="dot-frame">
                        ${generateDots(rightDots)}
                    </div>
                </div>`;
        }

        function generateDots(num) {
            let dots = '';
            for (let i = 0; i < num; i++) {
                let x = Math.random() * 290;
                let y = Math.random() * 290;
                dots += `<div class="dot" style="width: 4px; height: 4px; left: ${x}px; top: ${y}px;"></div>`;
            }
            return dots;
        }

        const numerosityTrial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: () => generateStimulus(),
            choices: "NO_KEYS",
            trial_duration: 200,
            data: {
                task: 'numerosity'
            }
        };

        const customResponse = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                return `
                    <div class="response-container">
                        <div class="sliders-wrapper">
                            <div class="slider-container">
                                <span>Left</span>
                                <div id="left-slider" class="custom-slider">
                                    <div id="left-marker" class="marker"></div>
                                </div>
                                <div id="left-value" class="confidence-value">50%</div>
                            </div>
                            <div class="slider-container">
                                <span>Right</span>
                                <div id="right-slider" class="custom-slider">
                                    <div id="right-marker" class="marker"></div>
                                </div>
                                <div id="right-value" class="confidence-value">50%</div>
                            </div>
                        </div>
                        <button id="continue-button" style="margin-left: 20px;" disabled>Continue</button>
                    </div>`;
            },
            choices: "NO_KEYS",
            on_load: function() {
                let selectedValue = null;
                let selectedSide = null;
                
                function updateSlider(e, slider, marker, valueDisplay, side, otherMarker, otherValue) {
                    const rect = slider.getBoundingClientRect();
                    let pos = (e.clientX - rect.left) / rect.width;
                    pos = Math.max(0, Math.min(1, pos));
                    
                    // Reset other slider
                    otherMarker.classList.remove('active');
                    otherValue.textContent = '50%';
                    
                    // Update current slider
                    marker.style.left = (pos * 100) + '%';
                    marker.classList.add('active');
                    selectedValue = pos * 50 + 50; // Scale to 50-100
                    valueDisplay.textContent = selectedValue.toFixed(1) + '%';
                    selectedSide = side;
                    
                    document.getElementById('continue-button').disabled = false;
                }

                const leftSlider = document.getElementById('left-slider');
                const rightSlider = document.getElementById('right-slider');
                const leftMarker = document.getElementById('left-marker');
                const rightMarker = document.getElementById('right-marker');
                const leftValue = document.getElementById('left-value');
                const rightValue = document.getElementById('right-value');

                leftSlider.addEventListener('click', function(e) {
                    updateSlider(e, leftSlider, leftMarker, leftValue, 'left', rightMarker, rightValue);
                });

                rightSlider.addEventListener('click', function(e) {
                    updateSlider(e, rightSlider, rightMarker, rightValue, 'right', leftMarker, leftValue);
                });

                document.getElementById('continue-button').addEventListener('click', function() {
                    const data = {
                        selected_side: selectedSide,
                        confidence_value: selectedValue,
                        left_confidence: selectedSide === 'left' ? selectedValue : 50,
                        right_confidence: selectedSide === 'right' ? selectedValue : 50
                    };
                    jsPsych.finishTrial(data);
                });
            },
            data: {
                task: 'confidence'
            }
        };

        const coverstory = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="color: white;">
                    <p>In this experiment, you will have the opportunity to receive advice... [cover story placeholder]</p>
                    <p>Press the button below to begin.</p>
                </div>
            `,
            choices: ['Start']
        };

        // Randomly select advice condition for each trial
        function getAdviceCondition() {
            return jsPsych.randomization.sampleWithoutReplacement([1, 2, 3], 1)[0];
        }   
         // Get random advice direction
         function getAdviceDirection() {
            return jsPsych.randomization.sampleWithoutReplacement(['left', 'right'], 1)[0];
        }
         // Create advice choice trial
         const adviceChoice = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">Would you like to receive advice?</div>',
            choices: ['Yes', 'No'],
            data: {
                task: 'advice_choice'
            },
            on_finish: function(data) {
                // Store the choice for use in conditional timeline
                jsPsych.data.addProperties({
                    advice_requested: data.response === 0 ? true : false
                });
            }
        };

          // Create advice display trials
          const adviceDisplay = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">You will now receive advice</div>',
            choices: ['Continue'],
            data: {
                task: 'advice_display'
            }
        };
        const actualAdvice = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                const direction = getAdviceDirection();
                return `<div style="color: white; font-size: 24px;">${direction}</div>`;
            },
            choices: "NO_KEYS",
            trial_duration: 800,
            data: {
                task: 'actual_advice'
            },
            on_finish: function(data) {
                // Store the advice given
                data.advice_direction = data.stimulus.includes('left') ? 'left' : 'right';
            }
        };
        const noAdviceDisplay = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<div style="color: white;">No advice available</div>',
            choices: ['Continue'],
            data: {
                task: 'no_advice_display'
            }
        };

        const blankScreen = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '',
            choices: "NO_KEYS",
            trial_duration: 300,
            data: {
                task: 'blank_screen'
            }
        };

        // Modify the custom response to store whether it's first or second rating
        function createConfidenceResponse(isSecond = false) {
            const trial = { ...customResponse }; // Clone the original response trial
            trial.data = {
                task: isSecond ? 'confidence_second' : 'confidence_first'
            };
            return trial;
        }

        // Create the timeline
        const timeline = [];

        // Add instructions
        const instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="color: white;">
                    <p>In this experiment, you will see two boxes with dots.</p>
                    <p>After making your initial confidence rating, you may receive advice.</p>
                    <p>You will then make a final confidence rating.</p>
                    <p>Press the button below to begin.</p>
                </div>
            `,
            choices: ['Start']
        };

        timeline.push(instructions);
        timeline.push(coverstory);
        // Create trial procedure
        for(let i = 0; i < 5; i++) {
            const trialProcedure = {
                timeline: [
                    fixation,
                    numerosityTrial,
                    createConfidenceResponse(false), // First confidence rating
                    {
                        timeline: [
                            adviceChoice,
                            {
                                timeline: [adviceDisplay, actualAdvice],
                                conditional_function: function() {
                                    const data = jsPsych.data.get().last(1).values()[0];
                                    return data.response === 0; // Only if they chose 'Yes'
                                }
                            },
                            {
                                timeline: [noAdviceDisplay, blankScreen],
                                conditional_function: function() {
                                    const data = jsPsych.data.get().last(1).values()[0];
                                    return data.response === 1; // Only if they chose 'No'
                                }
                            }
                        ],
                        conditional_function: function() {
                            // Condition 1: Show choice
                            return jsPsych.timelineVariable('condition') === 1;
                        }
                    },
                    {
                        timeline: [adviceDisplay, actualAdvice],
                        conditional_function: function() {
                            // Condition 2: Always show advice
                            return jsPsych.timelineVariable('condition') === 2;
                        }
                    },
                    {
                        timeline: [noAdviceDisplay, blankScreen],
                        conditional_function: function() {
                            // Condition 3: No advice available
                            return jsPsych.timelineVariable('condition') === 3;
                        }
                    },
                    createConfidenceResponse(true) // Second confidence rating
                ],
                timeline_variables: [{
                    condition: getAdviceCondition()
                }]
            };

            timeline.push(trialProcedure);
        }

        jsPsych.run(timeline);
        
      

    </script>
</body>
</html>